<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="boardgame-memory-card.html">

<dom-module id="boardgame-render-game-memory">
  <template>
    <style include="iron-flex iron-flex-alignment">
      paper-progress {
        width:100%;
      }
      .current {
        font-weight:bold;
      }
    </style>
    <h2>Memory</h2>
    <template is="dom-repeat" items="{{expandedState.Players}}">
      <div class$="{{IsCurrentPlayer(index, expandedState.Game.CurrentPlayer)}}">
        <span>Player {{index}}: {{item.WonCards.length}}</span>
      </div>
    </template>
    <div class="horizontal layout wrap container">
      <template is="dom-repeat" items="{{computedCards}}">
          <boardgame-memory-card title="{{index}}" rank="{{item.Values.Type}}" hidden="{{!Exists(item.Values)}}" spacer="{{!Exists(item)}}" index="{{index}}"></boardgame-memory-card>
      </template>
    </div>
    <paper-button id="hide" raised disabled="{{state.Computed.Global.CurrentPlayerHasCardsToReveal}}">Hide Cards</paper-button>
    <paper-progress id="timeleft" value="{{expandedState.Game.HideCardsTimer.TimeLeft}}" max="{{maxTimeLeft}}"></paper-progress>
  </template>

  <script>
    Polymer({
      is: 'boardgame-render-game-memory',
      properties: {
        state: Object,
        expandedState: Object,
        diagram : String,
        computedCards : {
          type: Array,
          computed: 'computeCards(expandedState.Game.HiddenCards, expandedState.Game.RevealedCards)'
        },
        maxTimeLeft: {
          type: Number,
          computed: 'computeMaxTimeLeft(expandedState.Game.HideCardsTimer.originalTimeLeft)'
        }
      },
      listeners: {
        'card-tapped' : 'handleCardTapped',
        'hide.tap' : 'hideTapped',
      },
      hideTapped : function(e) {
        this.fire("propose-move", {name: "Hide Cards", arguments: {}});
      },
      handleCardTapped: function(e) {
        this.fire("propose-move", {name: "Reveal Card", arguments: {
          "CardIndex": e.detail.index,
        }});
      },
      computeMaxTimeLeft: function(timeLeft) {
        return Math.max(timeLeft, 100);
      },
      computeCards : function(hidden, revealed) {
        let result = [];
        for (let i = 0; i < hidden.length; i++) {
          result.push(hidden[i]);
          if (!result[i]) {
            result[i] = revealed[i];
          }
        }
        return result;
      },
      IsCurrentPlayer : function(i, currentPlayer) {
        return (i == currentPlayer) ? "current" : "";
      },
      Exists: function(item) {
        return (item) ? true : false
      },
    });
  </script>
</dom-module>
