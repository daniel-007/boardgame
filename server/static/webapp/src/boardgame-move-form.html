<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../config-src/boardgame-config.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="boardgame-util.html">

<dom-module id="boardgame-move-form">
  <template>
    <style include="shared-styles">
      #moves > details {
        margin-left:1em;
      }
      h2 {
        margin-top:0;
        margin-bottom:0;
      }
    </style>
      <h2>Moves</h2>
      <div id="container">
        <template is="dom-repeat" items="{{config}}">
          <details id="moves-{{_normalizeID(item.Name)}}" >
            <summary on-tap="saveZippyState">Move {{item.Name}}</summary>
            <form>
              <p><em>{{item.Description}}</em></p>
              <input type="hidden" name="MoveType" value="{{item.Name}}">
              <input type="hidden" name="admin" value="{{boolToInt(admin)}}">
              <input type="hidden" name="player" value="{{moveAsPlayer}}">
              <template is="dom-repeat" items="{{item.Fields}}">
                <strong>{{item.Name}}</strong>
                <input name="{{item.Name}}" value="{{item.DefaultValue}}">
                <br/>
              </template>
              <div hidden$="{{item.Fields}}">
                <em>No modifiable fields</em><br/>
              </div>
              <input type="button" on-tap="doSubmitForm" value="Make Move">
            </form>
          </details>
        </template>
        <iron-ajax id="ajax" url="[[UrlForGameAPI(gameName, gameId, 'move')]]" method="POST" with-credentials last-response="{{formResponse}}" content-type="application/x-www-form-urlencoded"></iron-ajax>
      </div>
  </template>

  <script>
    Polymer({
      is: 'boardgame-move-form',
      properties: {
        config : {
          type: Object,
          observer: '_configChanged'
        },
        admin: Boolean,
        gameId: String,
        gameName: String,
        moveAsPlayer: Number,
        formResponse: {
          type: Object,
          observer: "_formResponseChanged"
        }
      },
      behaviors : [ApiHostBehavior, BoardgameUtilBehavior],
      boolToInt: function(bool) {
        return bool ? "1" : "0"
      },
      proposeMove: function(moveName, arguments) {
        if (!this.config) {
          console.warn("proposeMove called but no forms configed")
          return;
        }
        let moveConfig;
        for (let i = 0; i < this.config.length; i++) {
          let item = this.config[i];
          //TODO: fuzzy matching (remove whitespace and lowercase compare)
          if (item.Name == moveName) {
            moveConfig = item;
            break;
          }
        }

        if (!moveConfig) {
          console.warn("No move of name " + moveName + " found.");
          return;
        }

        let targetEleID = "#moves-" + this._normalizeID(moveConfig.Name);

        let containerEle = this.$$(targetEleID);

        if (!containerEle) {
          console.warn("Couldn't find move dom ele ", targetEleID);
          return;
        }

        let formEle = containerEle.querySelector("form");

        if (!formEle) {
          console.warn("Couldn't find form ele");
          return;
        }

        let inputs = formEle.elements;

        for (var key in arguments) {
          if (!arguments.hasOwnProperty(key)) continue;

          let fieldFilled = false;

          for (let i = 0; i < inputs.length; i++) {
            let element = inputs[i];
            if (element.type == "hidden") continue;
            if (element.type == "submit") continue;

            if (element.name == key) {
              element.value = arguments[key];
              fieldFilled = true;
            }

          }

          if (!fieldFilled) {
            console.warn("Couldn't find argument " + key + " in form.")
            return;
          }

        }
        this.submitForm(formEle);

      },
      doSubmitForm: function(e) {
        var evt = Polymer.dom(e);
        this.submitForm(evt.localTarget.form);
      },
      submitForm: function(formEle) {
        var body = {};
        var eles = formEle.elements;
        for (var i = 0; i < eles.length; i++) {
          var ele = eles[i];
          body[ele.name] = ele.value;
        }
        this.$.ajax.body = body;
        this.$.ajax.generateRequest();
      },
      _normalizeID: function(str) {
        return str.split(" ").join("")
      },
      _formResponseChanged: function(newValue) {
        if (newValue.Error) {
          this.fire("show-error", {message: newValue.Error, title: "Couldn't make move"})
        }
        //Let the game-view know that the move was made and we should see if
        //there's an updated version.
        this.fire("move-made");
      },
      _configChanged : function(newValue, oldValue) {
        //Must be async because databinding hasn't created the details yet.
        this.async(this.loadZippyState);
      },
      _storageKey : function(id) {
        //TODO: store the game ID in here too when we have one.
        return "move-form-zippy-" + id
      },
      saveZippyState : function(e) {


        var zippy = e.currentTarget.parentElement;
        if (!zippy.id.startsWith("moves")) {
          return
        }
        //This next if condition appears to be backwards, because by the time
        //the tap fires the zippy hasn't actually been opened (it will if we
        //don't preventDefault). So when we see zippy.open, it's the opposite
        //of what it will be.

        storageKey = this._storageKey(zippy.id)

        if (zippy.open) {
          sessionStorage.removeItem(storageKey)
        } else {
          sessionStorage.setItem(storageKey, true)
        }
      },
      loadZippyState : function() {
        var that = this;
        Polymer.dom(this.root).querySelectorAll("details").forEach(function(el) {
          if (!el.id.startsWith("moves")) {
            return;
          }
          //TODO: store in sessionStorage in a way that won't conflict across GAME IDs.
          var data = sessionStorage.getItem(that._storageKey(el.id));

          if (data) {
            el.open = true;
          }
        });
      }
    });
  </script>
</dom-module>
