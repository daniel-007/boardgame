<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../config-src/boardgame-config.html">
<link rel="import" href="boardgame-util.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="boardgame-current-player">
  <template>
    <h3>
      Playing as {{viewingAsPlayer}}
      <div hidden$="{{showJoin}}">
        <paper-button on-tap="showDialog">Join game</paper-button>
      </div>
    </h3>
    <paper-dialog id="join">
      <h2>Join game?</h2>
      <p>We're still looking for players for this game.</p>
      <div class="buttons">
        <paper-button dialog-dismiss>I'll just watch</paper-button>
        <paper-button dialog-confirm>I'm in!</paper-button>
      </div>
    </paper-dialog>
    <iron-ajax id="request" with-credentials url="[[UrlForGameAPI(gameName, gameId, 'join')]]" handle-as="json" last-response="{{response}}">
  </template>

  <script>
    Polymer({
      is: 'boardgame-current-player',
      properties: {
        viewingAsPlayer: Number,
        hasEmptySlots: Boolean,
        response: {
          type: Object,
          observer: "_responseChanged",
        }
      },

      listeners: {
        "iron-overlay-closed": "dialogClosed",
      },

      behaviors: [ApiHostBehavior, BoardgameUtilBehavior],

      showDialog: function() {
        if (this.$.join.opened) return;
        //TODO: have OserverPlayerIndex as a clientside constant
        if (this.viewingAsPlayer != -1) return;
        this.$.join.open();
      },

      dialogClosed: function(e) {
        if (e.detail.canceled) return;

        //Otherwise, assume it was confirmed.
        this.doJoin();
      },

      doJoin: function() {
        this.$.request.generateRequest();
      },

      _responseChanged: function(newValue) {
        console.log(newValue);
      },

    });
  </script>
</dom-module>
