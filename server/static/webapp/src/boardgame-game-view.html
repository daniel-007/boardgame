<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="boardgame-player-roster.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="boardgame-render-game.html">
<link rel="import" href="boardgame-admin-controls.html">
<link rel="import" href="boardgame-game-state-manager.html">

<dom-module id="boardgame-game-view">
  <template>
    <style include="shared-styles iron-flex">
      :host {
        display: block;
      }

      [hidden] {
        display:none !important;
      }

      #moves > details {
        margin-left:1em;
      }

      .admin > div:first-child {
        margin-left: 0;
      }

      .admin > div {
        margin-left:1em;
      }
    </style>
    <template is="dom-if" if="{{data.error}}">
    <div class="card">
    <h2>Error</h2>
    {{data.error}}
    </div>
    </template>

    <div class="card">
      <div hidden$="{{!game.Finished}}">
        <h1>Game over</h1>
        <div hidden$="{{!game.Winners}}">
          <h2>Winners:
            <template is="dom-repeat" items="{{game.Winners}}">
            {{item}}
            </template>
          </h2>
        </div>
        <div hidden$="{{game.Winners}}">
          <h3>It's a draw!</h3>
        </div>
      </div>
      <div hidden$="{{game.Finished}}">
        <boardgame-player-roster id="player" logged-in="{{loggedIn}}" game-name="{{gameName}}" game-id="{{gameId}}" viewing-as-player="{{viewingAsPlayer}}" has-empty-slots="{{hasEmptySlots}}" current-player-index="{{game.CurrentPlayerIndex}}" players-info="[[playersInfo]]" state="{{currentState}}"></boardgame-player-roster>
      </div>
    </div>
    <div class="card">
      <boardgame-render-game state="{{currentState}}" diagram="{{game.Diagram}}" game-name="{{gameName}}" viewing-as-player="{{viewingAsPlayer}}" current-player-index="{{game.CurrentPlayerIndex}}"></boardgame-render-game>
    </div>
    <boardgame-admin-controls id="admin" active="{{admin}}" game="[[game]]" viewing-as-player="[[viewingAsPlayer]]" move-forms="[[moveForms]]" game-id="[[gameId]]" game-name="[[gameName]]" chest="[[chest]]" game-state="[[gameState]]" requested-player="{{requestedPlayer}}"></boardgame-admin-controls>
    <boardgame-game-state-manager id="manager" game-name="[[gameName]]" game-id="[[gameId]]" requested-player="[[requestedPlayer]]" active="[[selected]]" chest="{{chest}}" admin="[[admin]]" game-finished="[[game.Finished]]" logged-in="[[loggedIn]]" players-info="{{playersInfo}}" has-empty-slots="{{hasEmptySlots}}"></boardgame-game-state-manager>
  </template>

  <script>

    class BoardgameGameView extends Polymer.Element {

      static get is() {
        return "boardgame-game-view"
      }

      static get properties() {
        return {

          requestedPlayer: {
            type: Number,
            value: 0,
          },
          chest : Object,
          gameState : String,
          game: Object,
          currentState: Object,
          gameId: {
            type: String,
            observer: "_gameIdChanged",
          },
          playersInfo: Array,
          hasEmptySlots: Boolean,
          gameName: String,
          admin: Boolean,
          selected: Boolean,
          loggedIn: Boolean,
          promptedToJoin: {
            type: Boolean,
            value: false,
          },
          pathsToTick: {
            type: Array
          },
          originalWallClockStartTime: {
            type: Number
          },
          viewingAsPlayer: {
            type: Number,
            value: 0,
          },
          moveForms: Object,
          _firstStateBundle: {
            type: Boolean,
            value: true,
          }
        }
      }

      ready() {
        super.ready();

        this.addEventListener('propose-move', e => this.handleProposeMove(e));
        this.addEventListener('move-made', e => this._handleMoveMade(e));
        this.addEventListener('refresh-data', e => this._handleRefreshData(e));
        this.addEventListener('install-state-bundle', e => this._handleStateBundle(e));
      }

      _handleMoveMade(e) {
        this.$.manager.fetchStatusNow();
      }

      _handleRefreshData(e) {
        this.$.manager.fetchData();
      }

      handleProposeMove(e) {
        let adminEle = this.shadowRoot.querySelector("#admin");

        if (!adminEle) {
          console.warn("propose-move fired, but no moves element to forward to.");
          return;
        }

        adminEle.proposeMove(e.detail.name, e.detail.arguments);
      }

      _gameIdChanged() {
        //reset this so the next time we get data set and notice that we COULD
        //login we prompt for it.
        this.promptedToJoin = false
      }

      doTick() {
        this._tick();
        if (this.pathsToTick.length > 0) {
          window.requestAnimationFrame(this.doTick.bind(this));
        }
      }

      _tick() {
        let newPaths = [];

        let pathToExpanded = ["currentState"]

        for (let i = 0; i < this.pathsToTick.length; i++) {
          let currentPath = this.pathsToTick[i];

          let pathToFetch = pathToExpanded.concat(currentPath);

          let timer = this.get(pathToFetch);

          let now = Date.now();
          let difference = now - this.originalWallClockStartTime;

          let result = Math.max(0, timer.originalTimeLeft - difference);

          this.set(pathToExpanded.concat(currentPath).concat(["TimeLeft"]), result);

          //If we still have time to tick on this, then make sure it's still
          //in the list of things to tick.
          if (timer.TimeLeft > 0) {
            newPaths.push(currentPath)
          }
        }

        this.pathsToTick = newPaths;
      }

      _handleStateBundle(e) {
        this._installStateBundle(e.detail);
      }

      _firstStateBundleInstalled() {
        if (this.selected && this.loggedIn && this.$.player.showJoin && !this.promptedToJoin) {

          //Take note that we already prompted them, and don't prompt again unless the game changes.
          this.promptedToJoin = true;
          //Prompt the user to join!
          this.$.player.showDialog();
        }
      }


      _installStateBundle(bundle) {
        this.game = bundle.game;
        this.currentState = bundle.game.CurrentState;
        this.moveForms = bundle.moveForms;
        this.viewingAsPlayer = bundle.viewingAsPlayer;
        this.originalWallClockStartTime = bundle.originalWallClockStartTime;
        this.gameState = bundle.gameState;
        this.pathsToTick = bundle.pathsToTick;

        if (this._firstStateBundle) {
          this._firstStateBundleInstalled();
        }
        this._firstStateBundle = false;

        window.requestAnimationFrame(() => this.doTick());
      }

    }

    customElements.define(BoardgameGameView.is, BoardgameGameView);

  </script>
</dom-module>
