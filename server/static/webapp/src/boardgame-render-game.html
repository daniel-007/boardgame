<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="boardgame-render-game">
  <template>
    <!--TODO: override with your own rendering here -->
    <div hidden$="{{rendererLoaded}}">
      <h2>Diagram of {{gameName}}</h2>
      <pre>{{diagram}}</pre>
    </div>
    <div id="container">
    <!-- This is where renderer will go -->
    </div>
  </template>

  <script>
    Polymer({
      is: 'boardgame-render-game',
      properties: {
        state: {
          type: Object,
          observer: "_stateChanged",
        },
        expandedState: {
          type: Object,
        },
        diagram : {
          type: String,
          observer: "_diagramChanged",
        },
        gameName: {
          type: String,
          observer: "_gameNameChanged",
        },
        renderer: Object,
        rendererLoaded: {
          type: Boolean,
          value: false,
        },
        viewingAsPlayer: {
          type: Number,
          observer: "_viewingAsPlayerChanged",
        }
      },
      observers: [
        "_expandedStateChanged(expandedState.*)"
      ],
      _diagramChanged : function(newValue) {
        if (!this.renderer) {
          return;
        }
        this.renderer.diagram = newValue;
      },
      _stateChanged: function(newValue) {
        if (!this.renderer) {
          return;
        }
        this.renderer.state = newValue;
      },
      _expandedStateChanged: function(record) {
        if (!this.renderer) return;
        this.renderer.set(record.path, record.value);
        //This shiouldn't be necessary... set should have already done
        //notifyPath. Bug in Polymer 2?
        this.renderer.notifyPath(record.path);
      },
      _viewingAsPlayerChanged: function(newValue) {
        if (!this.renderer) return;
        this.renderer.viewingAsPlayer = newValue;
      },
      _gameNameChanged : function(newValue) {
        this.rendererLoaded = false

        if (this.renderer) {
          Polymer.dom(this.$.container).removeChild(this.renderer);
        }
        this.renderer = null;


        var resolvedUrl = this.resolveUrl("../game-src/" +newValue + "/boardgame-render-game-" + newValue + ".html")
        this.importHref(resolvedUrl, this._instantiateRenderer, null, true);
      },
      _instantiateRenderer : function(e) {
        //The import loaded! Add it!
        this.rendererLoaded = true;

        var ele = document.createElement("boardgame-render-game-" + this.gameName);


        ele.diagram = this.diagram;
        ele.state = this.state;
        ele.expandedState = this.expandedState;
        ele.viewingAsPlayer = this.viewingAsPlayer;

        this.renderer = ele;

        Polymer.dom(this.$.container).appendChild(ele);

      }

    });
  </script>
</dom-module>
