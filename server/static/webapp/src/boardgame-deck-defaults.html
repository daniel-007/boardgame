<link rel="import" href="../bower_components/polymer/polymer-element.html">


<script>


  (function() {

    //defaultsInstances will be populated, on connected, by any boardgame-
    //deck-defaults taht has tempaltes.
    let defaultsInstances = [];
    //tempalte by name is templatized cached things to hand out.
    let templatesByName = {};

    //BoardgameDeckDefaults is really just a container for templates with a deck
    //property.
    class BoardgameDeckDefaults extends Polymer.Element {
      static get is() {
        return "boardgame-deck-defaults"
      }

      connectedCallback() {
        let template = this.querySelector("[deck]");
        if (!template) {
          //We must be just a reader defaults instance. Don't register.
          return
        }
        defaultsInstances.push(this);
      }

      disconnectedCallback() {
        var i = 0;
        while (i < defaultsInstances.length) {
          var item = defaultsInstances[i];
          if (i == this) {
            defaultsInstances.splice(i, 1);
          } else {
            i++;
          }
        }
      }

      templateForDeck(gameName, deckName) {

        //TODO: key cache off of gameName + deckName, figure out what our
        //gameName is.

        if (!deckName) {
          //This happens often when a new renderer is loaded and we don't yet
          //have the first state bundle.
          return null;
        }

        if (templatesByName[deckName]) return templatesByName[deckName];

        let template;
        let templateParentInstance;

        //Find the first defaults-instance that has it.
        for (let instance of defaultsInstances) {
          template = instance.querySelector("[deck=" + deckName + "]");
          if (template) {
            templateParentInstance = instance;
            break;
          }
        }

        if (!template) return null;

        let templateInstance = Polymer.Templatize.templatize(template, templateParentInstance);

        templatesByName[deckName] = templateInstance;

        return templateInstance;
      }
    }

    customElements.define(BoardgameDeckDefaults.is, BoardgameDeckDefaults);
  })();

</script>
